name: Production Deployment

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: [self-hosted, production]
    
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: ğŸ›¡ï¸ Backup Database
        run: |
          if [ -f "/home/fakturace/scripts/backup_db.sh" ]; then
            echo "Running pre-deployment backup..."
            /home/fakturace/scripts/backup_db.sh
          else
            echo "Warning: Backup script not found, skipping backup."
          fi

      # Backend Setup
      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: npm ci --omit=dev

      - name: ğŸ—„ï¸ Generate Prisma Client
        working-directory: ./backend
        run: npx prisma generate

      - name: ğŸ—„ï¸ Run Database Migrations
        working-directory: ./backend
        run: |
          # Load DATABASE_URL from production .env
          if [ -f "/opt/fakturace/backend/.env" ]; then
            export $(grep -E '^DATABASE_URL=' /opt/fakturace/backend/.env | xargs)
          fi
          npx prisma migrate deploy

      # Frontend Setup
      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ—ï¸ Build Frontend
        working-directory: ./frontend
        env:
          NEXT_TELEMETRY_DISABLED: 1
        run: npm run build

      - name: ğŸšš Deploy to Production Directory
        run: |
          echo "Syncing files to /opt/fakturace..."
          # PouÅ¾ijeme rsync pro synchronizaci.
          # --delete: smaÅ¾e soubory v cÃ­li, kterÃ© uÅ¾ nejsou ve zdroji (Ãºklid)
          # --exclude: vynechÃ¡me citlivÃ© soubory a uÅ¾ivatelskÃ¡ data
          rsync -av --delete \
            --exclude '.env' \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'uploads' \
            --exclude 'node_modules' \
            ./ /opt/fakturace/
            
          # Node modules kopÃ­rujeme zvlÃ¡Å¡Å¥ nebo nechÃ¡me instalovat tam?
          # ProtoÅ¾e jsme udÄ›lali 'npm ci' v runneru, je bezpeÄnÄ›jÅ¡Ã­ je tam taky pÅ™esunout,
          # ale rsync node_modules trvÃ¡ dlouho. 
          # RychlejÅ¡Ã­ je rsyncnout jen app a v /opt/fakturace spustit npm ci (symlinky atd).
          # Ale pro jednoduchost a jistotu verze teÄ zkopÃ­rujeme i backend/node_modules a frontend/node_modules.
          
          rsync -a --delete ./backend/node_modules/ /opt/fakturace/backend/node_modules/
          rsync -a --delete ./frontend/node_modules/ /opt/fakturace/frontend/node_modules/

      - name: ğŸš€ Restart PM2
        run: |
          cd /opt/fakturace
          pm2 restart ecosystem.config.js --update-env || pm2 start ecosystem.config.js
          pm2 save
          echo "âœ… PM2 services restarted successfully"
