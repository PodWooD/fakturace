name: Production Deployment

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: [self-hosted, production]
    
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: |
            backend/package-lock.json
            frontend/package-lock.json

      - name: ğŸ›¡ï¸ Backup Database
        run: |
          if [ -f "/home/fakturace/scripts/backup_db.sh" ]; then
            echo "Running pre-deployment backup..."
            /home/fakturace/scripts/backup_db.sh
          else
            echo "Warning: Backup script not found, skipping backup."
          fi

      # Backend Setup
      - name: ğŸ“¦ Install Backend Dependencies
        working-directory: ./backend
        run: npm ci --omit=dev

      - name: ğŸ—„ï¸ Generate Prisma Client
        working-directory: ./backend
        run: npx prisma generate

      - name: ğŸ—„ï¸ Run Database Migrations
        working-directory: ./backend
        # Prisma automaticky naÄte .env ze sloÅ¾ky, pokud existuje
        run: npx prisma migrate deploy

      # Frontend Setup
      - name: ğŸ“¦ Install Frontend Dependencies
        working-directory: ./frontend
        run: npm ci

      - name: ğŸ—ï¸ Build Frontend
        working-directory: ./frontend
        env:
          NEXT_TELEMETRY_DISABLED: 1
          # Frontend build Äasto potÅ™ebuje env vars (napÅ™. API URL).
          # ZkopÃ­rujeme lokÃ¡lnÃ­ .env z backendu nebo koÅ™ene, pokud je to potÅ™eba, 
          # ale Next.js build by mÄ›l projÃ­t i bez run-time secrets.
        run: npm run build

      # Restart Application
      - name: ğŸš€ Restart PM2
        run: |
          pm2 restart all
          pm2 save
          echo "Deployment successful! ğŸš€"
