# ğŸ“Š REPORT: AnalÃ½za Architektury Projektu Fakturace v1.0

## 1. PÅ˜EHLED PROJEKTU

**Fakturace v1.0** je komplexnÃ­ open-source systÃ©m pro sprÃ¡vu fakturace, pracovnÃ­ch zÃ¡znamÅ¯ technikÅ¯ a zpracovÃ¡nÃ­ pÅ™ijatÃ½ch faktur. Projekt je navrÅ¾en pro automatizaci ÃºÄetnÃ­ch procesÅ¯ s plnou auditnÃ­ podporou.

### KlÃ­ÄovÃ© vlastnosti:
- **Stav:** ProdukÄnÃ­ prostÅ™edÃ­
- **Verze:** 1.0.0
- **TechnologickÃ½ stack:** 100% open-source
- **Architektura:** ModernÃ­ full-stack aplikace (Backend API + Frontend SPA)

---

## 2. ARCHITEKTURA SYSTÃ‰MU

### 2.1 Backend (Node.js + Express)

**UmÃ­stÄ›nÃ­:** `/backend/`

**HlavnÃ­ technologie:**
- **Runtime:** Node.js 18+
- **Framework:** Express.js 4.18
- **ORM:** Prisma 5.8
- **DatabÃ¡ze:** PostgreSQL 15+
- **Autentizace:** JWT (jsonwebtoken)
- **Queue systÃ©m:** BullMQ + Redis
- **ÃšloÅ¾iÅ¡tÄ› souborÅ¯:** MinIO (S3 kompatibilnÃ­) s fallback na lokÃ¡lnÃ­ disk
- **Observability:** OpenTelemetry, Prometheus metrics

**Port:** 3029

**Struktura backendu:**
```
backend/src/
â”œâ”€â”€ app.js                  # HlavnÃ­ Express aplikace
â”œâ”€â”€ middleware/
â”‚   â””â”€â”€ auth.js            # JWT autentizace
â”œâ”€â”€ routes/                # REST API endpointy (13 souborÅ¯)
â”‚   â”œâ”€â”€ auth.js
â”‚   â”œâ”€â”€ organizations.js
â”‚   â”œâ”€â”€ workRecords.js
â”‚   â”œâ”€â”€ invoices.js
â”‚   â”œâ”€â”€ receivedInvoices.js
â”‚   â”œâ”€â”€ billing.js
â”‚   â”œâ”€â”€ hardware.js
â”‚   â”œâ”€â”€ services.js
â”‚   â”œâ”€â”€ accounting.js      # Lock/unlock period
â”‚   â”œâ”€â”€ audit.js          # AuditnÃ­ logy
â”‚   â”œâ”€â”€ users.js          # SprÃ¡va uÅ¾ivatelÅ¯
â”‚   â”œâ”€â”€ notifications.js
â”‚   â”œâ”€â”€ system.js         # Queue health
â”‚   â””â”€â”€ metrics.js        # Prometheus
â”œâ”€â”€ services/              # Business logika
â”‚   â”œâ”€â”€ ocrService.js     # OCR pÅ™es Mistral AI
â”‚   â”œâ”€â”€ isdocParser.js    # ISDOC formÃ¡t
â”‚   â”œâ”€â”€ pdfGenerator.js   # PDF faktury
â”‚   â”œâ”€â”€ pohodaExport.js   # XML export do Pohody
â”‚   â”œâ”€â”€ billingSummary.js
â”‚   â”œâ”€â”€ storageService.js # MinIO abstrakce
â”‚   â”œâ”€â”€ auditLogger.js
â”‚   â””â”€â”€ notificationService.js
â”œâ”€â”€ queues/                # BullMQ fronty
â”‚   â”œâ”€â”€ connection.js
â”‚   â”œâ”€â”€ ocrQueue.js
â”‚   â”œâ”€â”€ pdfQueue.js
â”‚   â”œâ”€â”€ pohodaQueue.js
â”‚   â”œâ”€â”€ isdocQueue.js
â”‚   â””â”€â”€ notificationQueue.js
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ accounting.js     # ÃšÄetnÃ­ utility
â”‚   â””â”€â”€ money.js          # PrÃ¡ce s mÄ›nou (halÃ©Å™e)
â”œâ”€â”€ queueWorker.js        # Worker pro zpracovÃ¡nÃ­ front
â”œâ”€â”€ metrics.js            # Prometheus metriky
â””â”€â”€ telemetry.js          # OpenTelemetry setup
```

**API Endpointy (13 modulÅ¯):**
1. `/api/auth` - PÅ™ihlÃ¡Å¡enÃ­, registrace
2. `/api/organizations` - SprÃ¡va klientÅ¯
3. `/api/work-records` - PracovnÃ­ zÃ¡znamy technikÅ¯
4. `/api/invoices` - VystavenÃ© faktury
5. `/api/received-invoices` - PÅ™ijatÃ© faktury
6. `/api/billing` - Billing nÃ¡stroje a draft
7. `/api/hardware` - Evidence HW/SW
8. `/api/services` - PauÅ¡Ã¡lnÃ­ sluÅ¾by
9. `/api/accounting` - Lock/unlock accounting period
10. `/api/audit` - AuditnÃ­ logy
11. `/api/users` - SprÃ¡va uÅ¾ivatelÅ¯
12. `/api/notifications` - Notifikace
13. `/api/system` - SystÃ©movÃ© info (queues health)

---

### 2.2 Frontend (Next.js 14)

**UmÃ­stÄ›nÃ­:** `/frontend/`

**HlavnÃ­ technologie:**
- **Framework:** Next.js 14 (App Router)
- **React:** 18.2
- **TypeScript:** 5.3
- **UI Framework:** Mantine v7 (komponenty, dark mode)
- **FormulÃ¡Å™e:** React Hook Form + Zod validace
- **Data fetching:** TanStack Query v5
- **Tabulky:** TanStack Table v8
- **HTTP klient:** Axios
- **Ikony:** Lucide React, Tabler Icons
- **Datum:** date-fns, dayjs

**Port:** 3030 (dev i production podle ecosystem.config.js)

**Struktura frontendu:**
```
frontend/src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ (auth)/
â”‚   â”‚   â””â”€â”€ login/        # PÅ™ihlaÅ¡ovacÃ­ strÃ¡nka
â”‚   â”œâ”€â”€ (dashboard)/      # Aplikace po pÅ™ihlÃ¡Å¡enÃ­
â”‚   â”‚   â”œâ”€â”€ layout.tsx    # Layout s navigacÃ­
â”‚   â”‚   â”œâ”€â”€ page.tsx      # Dashboard
â”‚   â”‚   â”œâ”€â”€ billing/
â”‚   â”‚   â”œâ”€â”€ export/
â”‚   â”‚   â”œâ”€â”€ hardware/
â”‚   â”‚   â”œâ”€â”€ import/
â”‚   â”‚   â”œâ”€â”€ invoices/
â”‚   â”‚   â”œâ”€â”€ organizations/
â”‚   â”‚   â”œâ”€â”€ received-invoices/
â”‚   â”‚   â”œâ”€â”€ reports/
â”‚   â”‚   â”œâ”€â”€ settings/     # NastavenÃ­ (theme, users)
â”‚   â”‚   â””â”€â”€ work-records/
â”‚   â”œâ”€â”€ globals.css
â”‚   â”œâ”€â”€ layout.tsx        # Root layout
â”‚   â””â”€â”€ providers.tsx     # Context providers
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ forms/
â”‚   â”‚   â”œâ”€â”€ OrganizationForm.tsx
â”‚   â”‚   â””â”€â”€ WorkRecordForm.tsx
â”‚   â””â”€â”€ navigation/
â”‚       â””â”€â”€ AppShell.tsx  # HlavnÃ­ navigace
â””â”€â”€ lib/
    â”œâ”€â”€ api-client.ts     # Axios konfigurace
    â”œâ”€â”€ auth-context.tsx  # Auth state
    â”œâ”€â”€ theme-context.tsx # Theme switch
    â”œâ”€â”€ permissions.ts    # RBAC
    â””â”€â”€ query-client.ts   # React Query setup
```

---

## 3. DATABÃZOVÃ‰ SCHÃ‰MA (Prisma)

**UmÃ­stÄ›nÃ­:** `/backend/prisma/schema.prisma`

### HlavnÃ­ tabulky:

| Tabulka | Popis | KlÃ­ÄovÃ© sloupce |
|---------|-------|-----------------|
| **User** | UÅ¾ivatelÃ© systÃ©mu | id, email, password, name, role (ADMIN/ACCOUNTANT/TECHNICIAN/VIEWER) |
| **Organization** | Klienti/spoleÄnosti | id, name, code, ico, dic, hourlyRateCents, kmRateCents, margins |
| **WorkRecord** | PracovnÃ­ zÃ¡znamy | id, organizationId, date, minutes, km, status (DRAFT/SUBMITTED/APPROVED) |
| **Service** | PauÅ¡Ã¡lnÃ­ sluÅ¾by | id, organizationId, monthlyPriceCents |
| **ReceivedInvoice** | PÅ™ijatÃ© faktury | id, supplierName, digest (unique), status, ocrPayload, sourceFilePath |
| **ReceivedInvoiceItem** | PoloÅ¾ky faktur | id, invoiceId, unitPriceCents, quantity, assignedOrganizationId |
| **Hardware** | HW/SW poloÅ¾ky | id, itemName, status (NEW/ASSIGNED/INVOICED), sourceInvoiceItemId |
| **Invoice** | VystavenÃ© faktury | id, invoiceNumber, status, totalAmountCents, pdfUrl, isdocUrl |
| **BillingDraft** | Draft faktury | id, organizationId, month, year, data (JSONB), roundingMode |
| **AccountingPeriod** | Lock obdobÃ­ | id, year, month, lockedAt |
| **AuditLog** | AuditnÃ­ zÃ¡znamy | id, actorId, entity, action, diffJson |
| **Notification** | Notifikace | id, type, level, userId |

**Celkem:** 12 modelÅ¯

**DÅ¯leÅ¾itÃ© vlastnosti:**
- VÅ¡echny penÄ›Å¾nÃ­ hodnoty v **halÃ©Å™Ã­ch** (integer cents)
- PodporovanÃ© mÄ›ny: CZK, EUR, USD
- DPH sazby: 0%, 12%, 21%
- ZaokrouhlovÃ¡nÃ­: HALF_UP, BANKERS
- Digest deduplication pro faktury
- JSONB pole pro flexibilnÃ­ data (billing drafts)

---

## 4. INFRASTRUKTURA & DEPLOYMENT

### 4.1 Docker Compose Setup

**UmÃ­stÄ›nÃ­:** `/docker-compose.yml`

**SluÅ¾by:**
1. **PostgreSQL 16** - Port 5433 (lokÃ¡lnÄ›)
2. **pgAdmin 8** - Port 8081 (admin UI)
3. **MinIO** - Porty 9000 (API), 9001 (Console)
4. **Redis 7** - Port 6379 (BullMQ)

**Credentials (dev):**
- Postgres: `fakturace / fakturace`
- pgAdmin: `admin@fakturace.local / admin123`
- MinIO: `fakturace / fakturace123`

### 4.2 PM2 Process Manager

**UmÃ­stÄ›nÃ­:** `/ecosystem.config.js`

**Procesy:**
1. **fakturace-backend** - Backend API (port 3029)
2. **fakturace-frontend** - Next.js (port 3030)
3. **fakturace-queues** - BullMQ worker

**Skript spuÅ¡tÄ›nÃ­:** `pm2 start ecosystem.config.js`

### 4.3 Nginx Reverse Proxy

**UmÃ­stÄ›nÃ­:** `/nginx.conf`

**Konfigurace:**
- Frontend `/` â†’ `localhost:3030`
- API `/api` â†’ `localhost:3029`
- Port 80 (HTTP)

---

## 5. FUNKÄŒNÃ MODULY

### 5.1 Autentizace & OprÃ¡vnÄ›nÃ­ (RBAC)

**Role:**
- **ADMIN** - PlnÃ½ pÅ™Ã­stup, fronty, accounting lock, audit
- **ACCOUNTANT** - Faktury, pÅ™ijatÃ© faktury, billing
- **TECHNICIAN** - VlastnÃ­ pracovnÃ­ zÃ¡znamy
- **VIEWER** - Pouze ÄtenÃ­

**OprÃ¡vnÄ›nÃ­:** `/frontend/src/lib/permissions.ts`
- CentralizovanÃ¡ logika oprÃ¡vnÄ›nÃ­
- Frontend i backend validace
- DynamickÃ© skrÃ½vÃ¡nÃ­ UI prvkÅ¯

### 5.2 Import & OCR

**OCR Provider:** Mistral AI OCR API
- AutomatickÃ© rozpoznÃ¡nÃ­ faktur
- Extrakce: dodavatel, ÄÃ­slo faktury, ÄÃ¡stky, poloÅ¾ky
- Alternativa: ISDOC parser, OCRmyPDF
- Fallback na manuÃ¡lnÃ­ zadÃ¡nÃ­

**Workflow:**
1. Upload pÅ™es `/api/received-invoices/upload`
2. Digest check (idempotence)
3. OCR queue job (BullMQ)
4. Parsing a uloÅ¾enÃ­ poloÅ¾ek
5. Notifikace o vÃ½sledku

### 5.3 Fronty (BullMQ + Redis)

**UmÃ­stÄ›nÃ­:** `/backend/src/queues/`

**DostupnÃ© fronty:**
1. **ocrQueue** - OCR zpracovÃ¡nÃ­ faktur
2. **pdfQueue** - GenerovÃ¡nÃ­ PDF
3. **pohodaQueue** - Export do Pohody XML
4. **isdocQueue** - ISDOC export
5. **notificationQueue** - ZasÃ­lÃ¡nÃ­ notifikacÃ­

**Fallback:** Pokud Redis nenÃ­ dostupnÃ½, Ãºlohy se provÃ¡dÄ›jÃ­ inline

**Monitoring:** `GET /api/system/queues` (pouze ADMIN)

### 5.4 ÃšloÅ¾iÅ¡tÄ› SouborÅ¯

**PrimÃ¡rnÃ­:** MinIO (S3 kompatibilnÃ­)
**Fallback:** LokÃ¡lnÃ­ disk (`backend/uploads/`)

**StorageService abstrakce:**
- AutomatickÃ½ fallback
- Migration script: `npm run migrate:uploads`
- Artefakty: PDF faktury, Pohoda XML, ISDOC, originÃ¡lnÃ­ faktury

### 5.5 Billing & Fakturace

**Workflow:**
1. **Draft vytvoÅ™enÃ­** - `/api/billing/draft`
   - Agregace pracovnÃ­ch zÃ¡znamÅ¯
   - Hardware/Software
   - PauÅ¡Ã¡lnÃ­ sluÅ¾by
   - VÃ½poÄet marÅ¾Ã­ a DPH
2. **Editace draftu** - JSONB data
3. **GenerovÃ¡nÃ­ faktury** - `/api/invoices/generate`
4. **Export**:
   - PDF (`/api/invoices/:id/pdf`)
   - ISDOC (`/api/invoices/:id/isdoc`)
   - Pohoda XML (`/api/invoices/:id/pohoda-xml`)

**Vlastnosti:**
- VÅ¡echny ÄÃ¡stky v halÃ©Å™Ã­ch
- RÅ¯znÃ© zaokrouhlovacÃ­ reÅ¾imy
- Workflow: DRAFT â†’ SENT â†’ PAID / CANCELLED

### 5.6 Accounting Lock

**Endpoint:** `/api/accounting/lock`

**Funkce:**
- UzamÄenÃ­ mÄ›sÃ­ce pro editace
- Prevence zmÄ›n historickÃ½ch dat
- Audit zÃ¡znam o lock/unlock
- Pouze ADMIN role

### 5.7 Audit Trail

**Tabulka:** `AuditLog`

**ZaznamenÃ¡vÃ¡:**
- Kdo (actorId)
- Co (entity + entityId)
- Kdy (createdAt)
- Akce (CREATE/UPDATE/DELETE/ASSIGN/GENERATE)
- Diff JSON (zmÄ›ny)

**PÅ™Ã­stup:** `/api/audit` (pouze ADMIN)

### 5.8 SprÃ¡va UÅ¾ivatelÅ¯

**UmÃ­stÄ›nÃ­:** `/frontend/src/app/(dashboard)/settings/`

**Funkce:**
- SprÃ¡va uÅ¾ivatelÅ¯ (pouze ADMIN s `users:manage`)
- PÅ™iÅ™azenÃ­ rolÃ­
- Reset hesla
- OdstranÄ›nÃ­ ÃºÄtÅ¯
- Theme switch (svÄ›tlÃ½/tmavÃ½ motiv)

---

## 6. OBSERVABILITY (PlÃ¡novanÃ©/ÄŒÃ¡steÄnÄ› implementovanÃ©)

### 6.1 Metriky (Prometheus)

**Endpoint:** `/metrics`
**Library:** prom-client

**DostupnÃ© metriky:**
- HTTP request duration
- Queue job counts
- OCR success/failure rates
- API response times

### 6.2 Tracing (OpenTelemetry)

**Status:** PÅ™ipraveno v kÃ³du
**Setup:** `/backend/src/telemetry.js`

**Exporters:**
- OTLP HTTP (traces)
- Prometheus metrics

**PlÃ¡novanÃ©:**
- Grafana dashboards
- Loki pro logy
- Jaeger/Tempo pro distributed tracing

---

## 7. INSTALACE & NASAZENÃ

### 7.1 LokÃ¡lnÃ­ Development

```bash
# 1. Infrastruktura
docker compose up -d

# 2. Backend
cd backend
npm install
npx prisma migrate deploy
npm run dev          # Port 3029
npm run worker       # Queue worker

# 3. Frontend
cd frontend
npm install
npm run dev          # Port 3030
```

**PÅ™ihlaÅ¡ovacÃ­ Ãºdaje (seed data):**
- Email: `admin@fakturace.cz`
- Heslo: `admin123`

### 7.2 Production Deployment

**Via PM2:**
```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

**Nginx:** Reverse proxy konfigurace v `/nginx.conf`

**Environment promÄ›nnÃ©:**
- Backend: `.env` (viz `.env.example`)
- Frontend: `.env.local`

---

## 8. TESTOVÃNÃ

### Backend Tests
**UmÃ­stÄ›nÃ­:** `/backend/tests/`
- `invoiceTotals.test.js` - Unit testy
- `import.integration.test.js` - Import workflow
- `billing.integration.test.js` - Billing logika
- `workflow.integration.test.js` - KompletnÃ­ workflow

**SpuÅ¡tÄ›nÃ­:** `npm test`
**PoÅ¾adavky:** PostgreSQL + `psql` CLI

### Frontend Tests
**Status:** TODO (plÃ¡novanÃ©)
**Framework:** Vitest (jiÅ¾ v package.json)

---

## 9. AKTUÃLNÃ STAV (Git)

**Branch:** `backup/20251019-0907`
**Main branch:** `main`

**ZmÄ›ny (unstaged/staged):**
- Dokumentace aktualizovÃ¡na
- Migrace na Next.js App Router dokonÄena
- PÅ™idÃ¡ny novÃ© funkce: ISDOC, metrics, notifications
- Legacy kÃ³d odstranÄ›n (Pages Router komponenty)

**NovÃ© soubory:**
- `docs/UPGRADE_NOTES_v1.0.md`
- `backend/src/queues/` - BullMQ fronty
- `backend/src/services/isdocExport.js`
- `frontend/src/app/` - App Router struktura

---

## 10. KONFIGURACE PORTÅ®

| SluÅ¾ba | Port | Popis |
|--------|------|-------|
| **Frontend (dev)** | 3030 | Next.js dev server |
| **Frontend (prod)** | 3030 | Next.js production |
| **Backend API** | 3029 | Express server |
| **PostgreSQL** | 5433 | DatabÃ¡ze (lokÃ¡lnÄ›) |
| **Redis** | 6379 | BullMQ fronty |
| **MinIO API** | 9000 | S3 kompatibilnÃ­ API |
| **MinIO Console** | 9001 | Web UI |
| **pgAdmin** | 8081 | Database admin UI |
| **Nginx** | 80 | Reverse proxy |
| **Grafana** | 3000 | Monitoring (ext. service) |

**PoznÃ¡mka:** Frontend v production podle PM2 bÄ›Å¾Ã­ na **portu 3030**; dev server byl sjednocen na stejnÃ½ port.

---

## 11. BEZPEÄŒNOST

**ImplementovÃ¡no:**
- JWT autentizace s Bearer tokens
- Bcrypt pro hashovÃ¡nÃ­ hesel
- CORS whitelist
- Role-based access control (RBAC)
- Audit trail pro vÅ¡echny operace
- Digest deduplication proti duplicitnÃ­m fakturÃ¡m

**Best Practices:**
- Environment promÄ›nnÃ© pro credentials
- Å½Ã¡dnÃ© hardcoded hesla
- JWT secret v `.env`
- MinIO/PostgreSQL credentials mimo git

---

## 12. ZÃVÄšR & DOPORUÄŒENÃ

### âœ… SilnÃ© strÃ¡nky:
1. **ModernÃ­ stack** - Next.js 14, Prisma, BullMQ
2. **100% open-source** - Å¾Ã¡dnÃ© vendor lock-in
3. **KomplexnÃ­ RBAC** - 4 ÃºrovnÄ› oprÃ¡vnÄ›nÃ­
4. **Audit trail** - plnÃ¡ sledovatelnost
5. **Scalabilita** - fronty, MinIO, Redis
6. **Dokumentace** - velmi dobrÃ¡ ÃºroveÅˆ

### âš ï¸ MoÅ¾nÃ¡ zlepÅ¡enÃ­:
1. **Frontend testy** - chybÃ­ (TODO)
2. **OpenTelemetry** - pouze ÄÃ¡steÄnÄ› implementovÃ¡no
3. **CI/CD** - nenÃ­ viditelnÃ½ pipeline
4. **Error handling** - obecnÃ½ error middleware
5. **Rate limiting** - nenÃ­ implementovÃ¡n
6. **SSL/TLS** - pouze HTTP v nginx.conf

### ğŸ“Š Komplexita projektu:
- **Backend:** ~40 souborÅ¯
- **Frontend:** ~14 hlavnÃ­ch komponent + strÃ¡nky
- **DatabÃ¡ze:** 12 modelÅ¯
- **API endpointy:** 13 modulÅ¯
- **Fronty:** 5 typÅ¯ Ãºloh
- **Dokumentace:** Velmi dobrÃ¡

### ğŸ¯ HlavnÃ­ use case:
SystÃ©m je **primÃ¡rnÄ› urÄen pro IT firmy** poskytujÃ­cÃ­ outsourcing sluÅ¾by, kde potÅ™ebujÃ­:
- Evidovat prÃ¡ci technikÅ¯ (hodiny + km)
- Zpracovat pÅ™ijatÃ© faktury HW/SW
- Vystavit faktury klientÅ¯m s marÅ¾emi
- Exportovat do ÃºÄetnÃ­ho systÃ©mu Pohoda
- AuditnÃ­ trail pro ÃºÄetnÃ­

---

**Datum analÃ½zy:** 2025-10-21
**AnalyzovanÃ¡ verze:** v1.0.0
**Status:** âœ… Projekt je funkÄnÃ­ a pÅ™ipravenÃ½ pro produkÄnÃ­ nasazenÃ­
