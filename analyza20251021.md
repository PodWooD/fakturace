# 📊 REPORT: Analýza Architektury Projektu Fakturace v1.0

## 1. PŘEHLED PROJEKTU

**Fakturace v1.0** je komplexní open-source systém pro správu fakturace, pracovních záznamů techniků a zpracování přijatých faktur. Projekt je navržen pro automatizaci účetních procesů s plnou auditní podporou.

### Klíčové vlastnosti:
- **Stav:** Produkční prostředí
- **Verze:** 1.0.0
- **Technologický stack:** 100% open-source
- **Architektura:** Moderní full-stack aplikace (Backend API + Frontend SPA)

---

## 2. ARCHITEKTURA SYSTÉMU

### 2.1 Backend (Node.js + Express)

**Umístění:** `/backend/`

**Hlavní technologie:**
- **Runtime:** Node.js 18+
- **Framework:** Express.js 4.18
- **ORM:** Prisma 5.8
- **Databáze:** PostgreSQL 15+
- **Autentizace:** JWT (jsonwebtoken)
- **Queue systém:** BullMQ + Redis
- **Úložiště souborů:** MinIO (S3 kompatibilní) s fallback na lokální disk
- **Observability:** OpenTelemetry, Prometheus metrics

**Port:** 3029

**Struktura backendu:**
```
backend/src/
├── app.js                  # Hlavní Express aplikace
├── middleware/
│   └── auth.js            # JWT autentizace
├── routes/                # REST API endpointy (13 souborů)
│   ├── auth.js
│   ├── organizations.js
│   ├── workRecords.js
│   ├── invoices.js
│   ├── receivedInvoices.js
│   ├── billing.js
│   ├── hardware.js
│   ├── services.js
│   ├── accounting.js      # Lock/unlock period
│   ├── audit.js          # Auditní logy
│   ├── users.js          # Správa uživatelů
│   ├── notifications.js
│   ├── system.js         # Queue health
│   └── metrics.js        # Prometheus
├── services/              # Business logika
│   ├── ocrService.js     # OCR přes Mistral AI
│   ├── isdocParser.js    # ISDOC formát
│   ├── pdfGenerator.js   # PDF faktury
│   ├── pohodaExport.js   # XML export do Pohody
│   ├── billingSummary.js
│   ├── storageService.js # MinIO abstrakce
│   ├── auditLogger.js
│   └── notificationService.js
├── queues/                # BullMQ fronty
│   ├── connection.js
│   ├── ocrQueue.js
│   ├── pdfQueue.js
│   ├── pohodaQueue.js
│   ├── isdocQueue.js
│   └── notificationQueue.js
├── utils/
│   ├── accounting.js     # Účetní utility
│   └── money.js          # Práce s měnou (haléře)
├── queueWorker.js        # Worker pro zpracování front
├── metrics.js            # Prometheus metriky
└── telemetry.js          # OpenTelemetry setup
```

**API Endpointy (13 modulů):**
1. `/api/auth` - Přihlášení, registrace
2. `/api/organizations` - Správa klientů
3. `/api/work-records` - Pracovní záznamy techniků
4. `/api/invoices` - Vystavené faktury
5. `/api/received-invoices` - Přijaté faktury
6. `/api/billing` - Billing nástroje a draft
7. `/api/hardware` - Evidence HW/SW
8. `/api/services` - Paušální služby
9. `/api/accounting` - Lock/unlock accounting period
10. `/api/audit` - Auditní logy
11. `/api/users` - Správa uživatelů
12. `/api/notifications` - Notifikace
13. `/api/system` - Systémové info (queues health)

---

### 2.2 Frontend (Next.js 14)

**Umístění:** `/frontend/`

**Hlavní technologie:**
- **Framework:** Next.js 14 (App Router)
- **React:** 18.2
- **TypeScript:** 5.3
- **UI Framework:** Mantine v7 (komponenty, dark mode)
- **Formuláře:** React Hook Form + Zod validace
- **Data fetching:** TanStack Query v5
- **Tabulky:** TanStack Table v8
- **HTTP klient:** Axios
- **Ikony:** Lucide React, Tabler Icons
- **Datum:** date-fns, dayjs

**Port:** 3030 (dev i production podle ecosystem.config.js)

**Struktura frontendu:**
```
frontend/src/
├── app/
│   ├── (auth)/
│   │   └── login/        # Přihlašovací stránka
│   ├── (dashboard)/      # Aplikace po přihlášení
│   │   ├── layout.tsx    # Layout s navigací
│   │   ├── page.tsx      # Dashboard
│   │   ├── billing/
│   │   ├── export/
│   │   ├── hardware/
│   │   ├── import/
│   │   ├── invoices/
│   │   ├── organizations/
│   │   ├── received-invoices/
│   │   ├── reports/
│   │   ├── settings/     # Nastavení (theme, users)
│   │   └── work-records/
│   ├── globals.css
│   ├── layout.tsx        # Root layout
│   └── providers.tsx     # Context providers
├── components/
│   ├── forms/
│   │   ├── OrganizationForm.tsx
│   │   └── WorkRecordForm.tsx
│   └── navigation/
│       └── AppShell.tsx  # Hlavní navigace
└── lib/
    ├── api-client.ts     # Axios konfigurace
    ├── auth-context.tsx  # Auth state
    ├── theme-context.tsx # Theme switch
    ├── permissions.ts    # RBAC
    └── query-client.ts   # React Query setup
```

---

## 3. DATABÁZOVÉ SCHÉMA (Prisma)

**Umístění:** `/backend/prisma/schema.prisma`

### Hlavní tabulky:

| Tabulka | Popis | Klíčové sloupce |
|---------|-------|-----------------|
| **User** | Uživatelé systému | id, email, password, name, role (ADMIN/ACCOUNTANT/TECHNICIAN/VIEWER) |
| **Organization** | Klienti/společnosti | id, name, code, ico, dic, hourlyRateCents, kmRateCents, margins |
| **WorkRecord** | Pracovní záznamy | id, organizationId, date, minutes, km, status (DRAFT/SUBMITTED/APPROVED) |
| **Service** | Paušální služby | id, organizationId, monthlyPriceCents |
| **ReceivedInvoice** | Přijaté faktury | id, supplierName, digest (unique), status, ocrPayload, sourceFilePath |
| **ReceivedInvoiceItem** | Položky faktur | id, invoiceId, unitPriceCents, quantity, assignedOrganizationId |
| **Hardware** | HW/SW položky | id, itemName, status (NEW/ASSIGNED/INVOICED), sourceInvoiceItemId |
| **Invoice** | Vystavené faktury | id, invoiceNumber, status, totalAmountCents, pdfUrl, isdocUrl |
| **BillingDraft** | Draft faktury | id, organizationId, month, year, data (JSONB), roundingMode |
| **AccountingPeriod** | Lock období | id, year, month, lockedAt |
| **AuditLog** | Auditní záznamy | id, actorId, entity, action, diffJson |
| **Notification** | Notifikace | id, type, level, userId |

**Celkem:** 12 modelů

**Důležité vlastnosti:**
- Všechny peněžní hodnoty v **haléřích** (integer cents)
- Podporované měny: CZK, EUR, USD
- DPH sazby: 0%, 12%, 21%
- Zaokrouhlování: HALF_UP, BANKERS
- Digest deduplication pro faktury
- JSONB pole pro flexibilní data (billing drafts)

---

## 4. INFRASTRUKTURA & DEPLOYMENT

### 4.1 Docker Compose Setup

**Umístění:** `/docker-compose.yml`

**Služby:**
1. **PostgreSQL 16** - Port 5433 (lokálně)
2. **pgAdmin 8** - Port 8081 (admin UI)
3. **MinIO** - Porty 9000 (API), 9001 (Console)
4. **Redis 7** - Port 6379 (BullMQ)

**Credentials (dev):**
- Postgres: `fakturace / fakturace`
- pgAdmin: `admin@fakturace.local / admin123`
- MinIO: `fakturace / fakturace123`

### 4.2 PM2 Process Manager

**Umístění:** `/ecosystem.config.js`

**Procesy:**
1. **fakturace-backend** - Backend API (port 3029)
2. **fakturace-frontend** - Next.js (port 3030)
3. **fakturace-queues** - BullMQ worker

**Skript spuštění:** `pm2 start ecosystem.config.js`

### 4.3 Nginx Reverse Proxy

**Umístění:** `/nginx.conf`

**Konfigurace:**
- Frontend `/` → `localhost:3030`
- API `/api` → `localhost:3029`
- Port 80 (HTTP)

---

## 5. FUNKČNÍ MODULY

### 5.1 Autentizace & Oprávnění (RBAC)

**Role:**
- **ADMIN** - Plný přístup, fronty, accounting lock, audit
- **ACCOUNTANT** - Faktury, přijaté faktury, billing
- **TECHNICIAN** - Vlastní pracovní záznamy
- **VIEWER** - Pouze čtení

**Oprávnění:** `/frontend/src/lib/permissions.ts`
- Centralizovaná logika oprávnění
- Frontend i backend validace
- Dynamické skrývání UI prvků

### 5.2 Import & OCR

**OCR Provider:** Mistral AI OCR API
- Automatické rozpoznání faktur
- Extrakce: dodavatel, číslo faktury, částky, položky
- Alternativa: ISDOC parser, OCRmyPDF
- Fallback na manuální zadání

**Workflow:**
1. Upload přes `/api/received-invoices/upload`
2. Digest check (idempotence)
3. OCR queue job (BullMQ)
4. Parsing a uložení položek
5. Notifikace o výsledku

### 5.3 Fronty (BullMQ + Redis)

**Umístění:** `/backend/src/queues/`

**Dostupné fronty:**
1. **ocrQueue** - OCR zpracování faktur
2. **pdfQueue** - Generování PDF
3. **pohodaQueue** - Export do Pohody XML
4. **isdocQueue** - ISDOC export
5. **notificationQueue** - Zasílání notifikací

**Fallback:** Pokud Redis není dostupný, úlohy se provádějí inline

**Monitoring:** `GET /api/system/queues` (pouze ADMIN)

### 5.4 Úložiště Souborů

**Primární:** MinIO (S3 kompatibilní)
**Fallback:** Lokální disk (`backend/uploads/`)

**StorageService abstrakce:**
- Automatický fallback
- Migration script: `npm run migrate:uploads`
- Artefakty: PDF faktury, Pohoda XML, ISDOC, originální faktury

### 5.5 Billing & Fakturace

**Workflow:**
1. **Draft vytvoření** - `/api/billing/draft`
   - Agregace pracovních záznamů
   - Hardware/Software
   - Paušální služby
   - Výpočet marží a DPH
2. **Editace draftu** - JSONB data
3. **Generování faktury** - `/api/invoices/generate`
4. **Export**:
   - PDF (`/api/invoices/:id/pdf`)
   - ISDOC (`/api/invoices/:id/isdoc`)
   - Pohoda XML (`/api/invoices/:id/pohoda-xml`)

**Vlastnosti:**
- Všechny částky v haléřích
- Různé zaokrouhlovací režimy
- Workflow: DRAFT → SENT → PAID / CANCELLED

### 5.6 Accounting Lock

**Endpoint:** `/api/accounting/lock`

**Funkce:**
- Uzamčení měsíce pro editace
- Prevence změn historických dat
- Audit záznam o lock/unlock
- Pouze ADMIN role

### 5.7 Audit Trail

**Tabulka:** `AuditLog`

**Zaznamenává:**
- Kdo (actorId)
- Co (entity + entityId)
- Kdy (createdAt)
- Akce (CREATE/UPDATE/DELETE/ASSIGN/GENERATE)
- Diff JSON (změny)

**Přístup:** `/api/audit` (pouze ADMIN)

### 5.8 Správa Uživatelů

**Umístění:** `/frontend/src/app/(dashboard)/settings/`

**Funkce:**
- Správa uživatelů (pouze ADMIN s `users:manage`)
- Přiřazení rolí
- Reset hesla
- Odstranění účtů
- Theme switch (světlý/tmavý motiv)

---

## 6. OBSERVABILITY (Plánované/Částečně implementované)

### 6.1 Metriky (Prometheus)

**Endpoint:** `/metrics`
**Library:** prom-client

**Dostupné metriky:**
- HTTP request duration
- Queue job counts
- OCR success/failure rates
- API response times

### 6.2 Tracing (OpenTelemetry)

**Status:** Připraveno v kódu
**Setup:** `/backend/src/telemetry.js`

**Exporters:**
- OTLP HTTP (traces)
- Prometheus metrics

**Plánované:**
- Grafana dashboards
- Loki pro logy
- Jaeger/Tempo pro distributed tracing

---

## 7. INSTALACE & NASAZENÍ

### 7.1 Lokální Development

```bash
# 1. Infrastruktura
docker compose up -d

# 2. Backend
cd backend
npm install
npx prisma migrate deploy
npm run dev          # Port 3029
npm run worker       # Queue worker

# 3. Frontend
cd frontend
npm install
npm run dev          # Port 3030
```

**Přihlašovací údaje (seed data):**
- Email: `admin@fakturace.cz`
- Heslo: `admin123`

### 7.2 Production Deployment

**Via PM2:**
```bash
pm2 start ecosystem.config.js
pm2 save
pm2 startup
```

**Nginx:** Reverse proxy konfigurace v `/nginx.conf`

**Environment proměnné:**
- Backend: `.env` (viz `.env.example`)
- Frontend: `.env.local`

---

## 8. TESTOVÁNÍ

### Backend Tests
**Umístění:** `/backend/tests/`
- `invoiceTotals.test.js` - Unit testy
- `import.integration.test.js` - Import workflow
- `billing.integration.test.js` - Billing logika
- `workflow.integration.test.js` - Kompletní workflow

**Spuštění:** `npm test`
**Požadavky:** PostgreSQL + `psql` CLI

### Frontend Tests
**Status:** TODO (plánované)
**Framework:** Vitest (již v package.json)

---

## 9. AKTUÁLNÍ STAV (Git)

**Branch:** `backup/20251019-0907`
**Main branch:** `main`

**Změny (unstaged/staged):**
- Dokumentace aktualizována
- Migrace na Next.js App Router dokončena
- Přidány nové funkce: ISDOC, metrics, notifications
- Legacy kód odstraněn (Pages Router komponenty)

**Nové soubory:**
- `docs/UPGRADE_NOTES_v1.0.md`
- `backend/src/queues/` - BullMQ fronty
- `backend/src/services/isdocExport.js`
- `frontend/src/app/` - App Router struktura

---

## 10. KONFIGURACE PORTŮ

| Služba | Port | Popis |
|--------|------|-------|
| **Frontend (dev)** | 3030 | Next.js dev server |
| **Frontend (prod)** | 3030 | Next.js production |
| **Backend API** | 3029 | Express server |
| **PostgreSQL** | 5433 | Databáze (lokálně) |
| **Redis** | 6379 | BullMQ fronty |
| **MinIO API** | 9000 | S3 kompatibilní API |
| **MinIO Console** | 9001 | Web UI |
| **pgAdmin** | 8081 | Database admin UI |
| **Nginx** | 80 | Reverse proxy |
| **Grafana** | 3000 | Monitoring (ext. service) |

**Poznámka:** Frontend v production podle PM2 běží na **portu 3030**; dev server byl sjednocen na stejný port.

---

## 11. BEZPEČNOST

**Implementováno:**
- JWT autentizace s Bearer tokens
- Bcrypt pro hashování hesel
- CORS whitelist
- Role-based access control (RBAC)
- Audit trail pro všechny operace
- Digest deduplication proti duplicitním fakturám

**Best Practices:**
- Environment proměnné pro credentials
- Žádné hardcoded hesla
- JWT secret v `.env`
- MinIO/PostgreSQL credentials mimo git

---

## 12. ZÁVĚR & DOPORUČENÍ

### ✅ Silné stránky:
1. **Moderní stack** - Next.js 14, Prisma, BullMQ
2. **100% open-source** - žádné vendor lock-in
3. **Komplexní RBAC** - 4 úrovně oprávnění
4. **Audit trail** - plná sledovatelnost
5. **Scalabilita** - fronty, MinIO, Redis
6. **Dokumentace** - velmi dobrá úroveň

### ⚠️ Možná zlepšení:
1. **Frontend testy** - chybí (TODO)
2. **OpenTelemetry** - pouze částečně implementováno
3. **CI/CD** - není viditelný pipeline
4. **Error handling** - obecný error middleware
5. **Rate limiting** - není implementován
6. **SSL/TLS** - pouze HTTP v nginx.conf

### 📊 Komplexita projektu:
- **Backend:** ~40 souborů
- **Frontend:** ~14 hlavních komponent + stránky
- **Databáze:** 12 modelů
- **API endpointy:** 13 modulů
- **Fronty:** 5 typů úloh
- **Dokumentace:** Velmi dobrá

### 🎯 Hlavní use case:
Systém je **primárně určen pro IT firmy** poskytující outsourcing služby, kde potřebují:
- Evidovat práci techniků (hodiny + km)
- Zpracovat přijaté faktury HW/SW
- Vystavit faktury klientům s maržemi
- Exportovat do účetního systému Pohoda
- Auditní trail pro účetní

---

**Datum analýzy:** 2025-10-21
**Analyzovaná verze:** v1.0.0
**Status:** ✅ Projekt je funkční a připravený pro produkční nasazení
